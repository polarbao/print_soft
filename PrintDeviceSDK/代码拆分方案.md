# PrintDeviceSDK 代码拆分方案

## 当前问题

当前`PrintDeviceSDK_API.cpp`约500行，包含所有功能：
- SDKManager类的完整实现
- 所有C API函数实现
- 信号槽处理逻辑
- 连接管理、运动控制、打印控制混在一起

## 拆分的好处

1. ✅ **代码组织清晰** - 每个文件职责单一
2. ✅ **易于维护** - 修改某个功能只需关注对应文件
3. ✅ **便于团队协作** - 不同人可以同时修改不同模块
4. ✅ **编译效率** - 修改某个模块只需重新编译该文件
5. ✅ **代码复用** - 各模块独立，便于单元测试

## 推荐方案一：功能模块拆分（推荐）

### 文件结构

```
PrintDeviceSDK/
├── src/
│   ├── SDKManager.h              # SDK管理器头文件
│   ├── SDKManager.cpp            # SDK管理器基础实现
│   ├── SDKConnection.cpp         # 连接管理实现
│   ├── SDKMotion.cpp             # 运动控制实现
│   ├── SDKPrint.cpp              # 打印控制实现
│   └── SDKCallback.cpp           # 回调和事件处理
├── PrintDeviceSDK_API.h          # 公共C接口
└── PrintDeviceSDK_API.cpp        # C API包装层
```

### 文件职责划分

#### 1. SDKManager.h（约100行）
```cpp
#ifndef SDK_MANAGER_H
#define SDK_MANAGER_H

#include <QObject>
#include <QMutex>
#include <memory>

class TcpClient;
class ProtocolPrint;
class QTimer;

/**
 * @brief SDK内部管理类
 * 负责资源管理和模块协调
 */
class SDKManager : public QObject {
    Q_OBJECT

public:
    static SDKManager* instance();
    
    // 生命周期管理
    bool init(const char* log_dir);
    void release();
    
    // 连接管理（实现在SDKConnection.cpp）
    int connectByTCP(const QString& ip, unsigned short port);
    void disconnect();
    bool isConnected() const;
    
    // 运动控制（实现在SDKMotion.cpp）
    int moveXAxis(double distance, bool isAbsolute);
    int moveYAxis(double distance, bool isAbsolute);
    int moveZAxis(double distance, bool isAbsolute);
    int resetAxis(int axisFlag);
    
    // 打印控制（实现在SDKPrint.cpp）
    int startPrint();
    int stopPrint();
    int pausePrint();
    int resumePrint();
    int resetPrint();
    int loadImageData(const QString& imagePath);
    
    // 访问内部对象
    TcpClient* tcpClient() { return m_tcpClient.get(); }
    ProtocolPrint* protocol() { return m_protocol.get(); }

private slots:
    // 信号处理（实现在SDKCallback.cpp）
    void onRecvData(QByteArray data);
    void onTcpError(QAbstractSocket::SocketError error);
    void onStateChanged(QAbstractSocket::SocketState state);
    void onHeartbeat();
    void onCmdReply(int cmd, uchar errCode, QByteArray arr);
    void onSendHeartbeat();
    void onCheckHeartbeat();

private:
    SDKManager();
    ~SDKManager();
    SDKManager(const SDKManager&) = delete;
    SDKManager& operator=(const SDKManager&) = delete;
    
    void sendCommand(int code, const QByteArray& data = QByteArray());
    void sendEvent(int type, int code, const char* message, 
                   double v1 = 0.0, double v2 = 0.0, double v3 = 0.0);

    // 成员变量
    bool m_initialized;
    std::unique_ptr<TcpClient> m_tcpClient;
    std::unique_ptr<ProtocolPrint> m_protocol;
    std::unique_ptr<QTimer> m_heartbeatSendTimer;
    std::unique_ptr<QTimer> m_heartbeatCheckTimer;
    QMutex m_heartbeatMutex;
    int m_heartbeatTimeout;
};

#endif // SDK_MANAGER_H
```

#### 2. SDKManager.cpp（约100行）
基础管理功能：
- 单例实现
- init/release
- 辅助函数（sendCommand, sendEvent）
- 构造/析构

#### 3. SDKConnection.cpp（约100行）
连接管理功能：
- connectByTCP
- disconnect
- isConnected
- 心跳定时器设置
- 连接状态事件处理

#### 4. SDKMotion.cpp（约80行）
运动控制功能：
- moveXAxis
- moveYAxis
- moveZAxis
- resetAxis
- 运动命令发送

#### 5. SDKPrint.cpp（约100行）
打印控制功能：
- startPrint
- stopPrint
- pausePrint
- resumePrint
- resetPrint
- loadImageData
- 图像数据处理

#### 6. SDKCallback.cpp（约120行）
事件回调处理：
- onRecvData
- onTcpError
- onStateChanged
- onHeartbeat
- onCmdReply
- onSendHeartbeat
- onCheckHeartbeat

#### 7. PrintDeviceSDK_API.cpp（约100行）
C API包装层：
- 只包含C函数实现
- 简单调用SDKManager的方法
- 不包含业务逻辑

### 代码示例

#### SDKManager.cpp（基础部分）
```cpp
#include "SDKManager.h"
#include "../print_soft_0_0_1/src/communicate/TcpClient.h"
#include "../print_soft_0_0_1/src/protocol/ProtocolPrint.h"

SDKManager* SDKManager::instance() {
    static SDKManager manager;
    return &manager;
}

SDKManager::SDKManager() 
    : m_initialized(false)
    , m_heartbeatTimeout(0) 
{
}

SDKManager::~SDKManager() {
    release();
}

bool SDKManager::init(const char* log_dir) {
    // 创建核心对象
    m_tcpClient = std::make_unique<TcpClient>();
    m_protocol = std::make_unique<ProtocolPrint>();
    
    // 连接信号槽
    connect(m_tcpClient.get(), &TcpClient::sigNewData, 
            this, &SDKManager::onRecvData);
    // ... 其他连接
    
    m_initialized = true;
    return true;
}

void SDKManager::release() {
    // 清理资源
    m_tcpClient.reset();
    m_protocol.reset();
    m_initialized = false;
}

void SDKManager::sendCommand(int code, const QByteArray& data) {
    if (m_tcpClient) {
        QByteArray packet = ProtocolPrint::GetSendDatagram(
            static_cast<ProtocolPrint::FunCode>(code), data);
        m_tcpClient->sendData(packet);
    }
}
```

#### SDKConnection.cpp
```cpp
#include "SDKManager.h"
#include "../print_soft_0_0_1/src/communicate/TcpClient.h"
#include "../print_soft_0_0_1/src/protocol/ProtocolPrint.h"
#include <QTimer>

int SDKManager::connectByTCP(const QString& ip, unsigned short port) {
    if (!m_initialized || !m_tcpClient) {
        return -1;
    }
    
    m_tcpClient->setIpAndPort(ip, port);
    m_tcpClient->connectToHost();
    return 0;
}

void SDKManager::disconnect() {
    if (m_tcpClient) {
        if (m_heartbeatSendTimer) m_heartbeatSendTimer->stop();
        if (m_heartbeatCheckTimer) m_heartbeatCheckTimer->stop();
        m_tcpClient->disconnectFromHost();
    }
}

bool SDKManager::isConnected() const {
    if (m_tcpClient) {
        return m_tcpClient->isConnected();
    }
    return false;
}
```

#### SDKMotion.cpp
```cpp
#include "SDKManager.h"
#include "../print_soft_0_0_1/src/protocol/ProtocolPrint.h"

int SDKManager::moveXAxis(double distance, bool isAbsolute) {
    if (!isConnected()) return -1;
    
    if (distance > 0) {
        sendCommand(ProtocolPrint::Set_XAxisMovePrintPos);
    } else {
        sendCommand(ProtocolPrint::Set_XAxisReset);
    }
    return 0;
}

int SDKManager::moveYAxis(double distance, bool isAbsolute) {
    if (!isConnected()) return -1;
    
    if (distance > 0) {
        sendCommand(ProtocolPrint::Set_YAxisMovePrintPos);
    } else {
        sendCommand(ProtocolPrint::Set_YAxisReset);
    }
    return 0;
}

int SDKManager::moveZAxis(double distance, bool isAbsolute) {
    if (!isConnected()) return -1;
    
    if (distance > 0) {
        if (distance >= 10.0) {
            sendCommand(ProtocolPrint::Set_ZAxisUpAuto);
        } else {
            sendCommand(ProtocolPrint::Set_ZAxisUp1CM);
        }
    } else {
        if (distance <= -10.0) {
            sendCommand(ProtocolPrint::Set_ZAxisDownAuto);
        } else {
            sendCommand(ProtocolPrint::Set_ZAxisDown1CM);
        }
    }
    return 0;
}

int SDKManager::resetAxis(int axisFlag) {
    if (!isConnected()) return -1;
    
    if (axisFlag & 1) sendCommand(ProtocolPrint::Set_XAxisReset);
    if (axisFlag & 2) sendCommand(ProtocolPrint::Set_YAxisReset);
    if (axisFlag & 4) sendCommand(ProtocolPrint::Set_ZAxisReset);
    
    return 0;
}
```

#### SDKPrint.cpp
```cpp
#include "SDKManager.h"
#include "../print_soft_0_0_1/src/protocol/ProtocolPrint.h"
#include <QFile>
#include <QImage>

int SDKManager::startPrint() {
    if (!isConnected()) return -1;
    sendCommand(ProtocolPrint::Set_StartPrint);
    return 0;
}

int SDKManager::stopPrint() {
    if (!isConnected()) return -1;
    sendCommand(ProtocolPrint::Set_StopPrint);
    return 0;
}

int SDKManager::pausePrint() {
    if (!isConnected()) return -1;
    sendCommand(ProtocolPrint::Set_PausePrint);
    return 0;
}

int SDKManager::resumePrint() {
    if (!isConnected()) return -1;
    sendCommand(ProtocolPrint::Set_continuePrint);
    return 0;
}

int SDKManager::loadImageData(const QString& imagePath) {
    if (!isConnected()) return -1;
    
    QImage img(imagePath);
    if (img.isNull()) {
        sendEvent(2, -1, "Failed to load image");
        return -1;
    }
    
    // 读取和发送图像数据...
    return 0;
}
```

## 方案二：简化拆分（如果时间紧）

只拆分出SDKManager类，其他保持不变：

```
PrintDeviceSDK/
├── src/
│   ├── SDKManager.h
│   └── SDKManager.cpp          # 所有SDKManager实现
├── PrintDeviceSDK_API.h
└── PrintDeviceSDK_API.cpp      # C API包装
```

这种方式拆分工作量小，但改进有限。

## 项目文件更新

### PrintDeviceSDK.pro（方案一）
```qmake
HEADERS += \
    PrintDeviceSDK_API.h \
    src/SDKManager.h

SOURCES += \
    PrintDeviceSDK_API.cpp \
    src/SDKManager.cpp \
    src/SDKConnection.cpp \
    src/SDKMotion.cpp \
    src/SDKPrint.cpp \
    src/SDKCallback.cpp

# 包含目录
INCLUDEPATH += src
```

### CMakeLists.txt（方案一）
```cmake
set(SDK_HEADERS
    PrintDeviceSDK_API.h
    src/SDKManager.h
)

set(SDK_SOURCES
    PrintDeviceSDK_API.cpp
    src/SDKManager.cpp
    src/SDKConnection.cpp
    src/SDKMotion.cpp
    src/SDKPrint.cpp
    src/SDKCallback.cpp
)
```

## 实施步骤

### 方案一实施步骤：

1. **创建目录结构**
   ```bash
   mkdir -p PrintDeviceSDK/src
   ```

2. **创建SDKManager.h**
   - 提取类声明
   - 添加必要的前向声明

3. **拆分功能到各个cpp文件**
   - SDKManager.cpp - 基础管理
   - SDKConnection.cpp - 连接功能
   - SDKMotion.cpp - 运动控制
   - SDKPrint.cpp - 打印控制
   - SDKCallback.cpp - 回调处理

4. **简化PrintDeviceSDK_API.cpp**
   - 只保留C API函数
   - 包含SDKManager.h

5. **更新项目文件**
   - 更新.pro文件
   - 更新CMakeLists.txt

6. **编译测试**
   - 编译SDK
   - 运行示例程序
   - 确保功能正常

## 对比总结

| 方面 | 当前方案 | 方案一（模块化） | 方案二（简化） |
|------|---------|----------------|---------------|
| 文件数量 | 2个 | 8个 | 4个 |
| 代码组织 | 混在一起 | ⭐⭐⭐⭐⭐ 清晰 | ⭐⭐⭐ 一般 |
| 可维护性 | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 协作友好 | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 实施难度 | - | ⭐⭐⭐ 中等 | ⭐⭐ 简单 |
| 编译效率 | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |

## 推荐建议

**强烈推荐使用方案一（模块化拆分）**

理由：
1. ✅ 代码结构清晰，职责分明
2. ✅ 便于后续维护和扩展
3. ✅ 团队协作更友好
4. ✅ 修改局部功能只需重新编译对应模块
5. ✅ 便于单元测试
6. ✅ 虽然初期工作量大一点，但长期收益明显

如果时间紧张，可以先使用方案二过渡，后续再重构为方案一。

