## 一、通信方式

TCP/IP形式进行通信，上位机作为客户端，下位机作为服务器进行连接。

* 服务器固定IP：192.168.1.100
* 监听端口：5555

## **二、通讯协议**

包头(2byte) +  命令类型(2byte) +命令字(2byte)+ 数据区长度(2byte) + 数据区(动态，从0到nbyte) + crc16校验(2byte)

**备注：**通讯协议的字节长度，至少10个字节，随数据区变化，协议字段采用小端字节序。

---

## **三、协议解析**

### **3.1**** 包头(2字节)**

* 发送包头                0xAABB
* 处理成功                0xAACC
* 处理失败                0xAADD

备注：小端字节序，低位在前（BB AA）

---

### **3.2**** 数据区****长度(2字节)**

* 数据区字节
  * 12 byte
  * 0 byte

---

### 3.3 命令类型（2字节）

* 设置参数：0x0001
* 获取命令：0x0010
* 控制命令：0x0011
* 打印通讯：0x00F0

---

### **3.4**** 命令****字****(2字节)**

#### **3.4.1**** 设置****参数****（0x1000****段****）**

上位机启动时，加载文件，配置打印机清洗、起点、终点位置(XY)

* 清洗位置：0x1000
* 打印起点：0x1001
* 打印终点：0x1002

0xAABB+命令类型（**0x0001**)+命令字+ 长度(0x000C)+ 数据区（12Byte）+ crc16

数据区：发送X、Y、Z坐标信息

**步进经验值 （0x1010）**

* Y轴步进经验值
* Z轴步进经验值

数据区：

Y轴数据位为4-7字节

Z轴数据位为8-11字节

步进单位：微米μm

**限位（最大移动位置、后续版本增加） 0x1020**

* X轴限位
* Y轴限位
* Z轴限位

数据区：

X轴数据位为0-3字节

Y轴数据位为4-7字节

Z轴数据位为8-11字节

数据区：发送坐标信息

**速度（后续版本增加） 0x1030**

* X轴速度
* Y轴速度
* Z轴速度

说明：

数据区4字节代表1个轴，0表示不设置走默认参数；

单位：mm/s

X轴数据位为0-3字节

Y轴数据位为4-7字节

Z轴数据位为8-11字节

#### **3.4.2**** ****获取命令（0x2000段）**

* X轴位置
* Y轴位置
* Z轴位置

单位：坐标信息 **0x2000**

X轴数据位为0-3字节

Y轴数据位为4-7字节

Z轴数据位为8-11字节

**发送：**

0xAABB+命令类型（**0x0010**)+命令字+ 长度(0x0000)+crc16

**应答：**

0xAACC+命令类型（**0x0010**)+命令字+ 长度(0x000C)+数据区 + crc16

#### **3.4.3**** ****控制命令（0x3000段）**

* **开始打印****（0x3000）手动控制关闭**
* **暂停打印****（0x3001）****  **
* **继续****打印****（0x3002）**
* **停止打印（0x3003） 手动控制打开**

0xAABB+命令类型（**0x0011**)+命令字+ 长度(0x0000)+ crc16

**复位(0x3004)**

* X轴复位
* Y轴复位
* Z轴服务

说明：数据区4字节代表1个轴，0表示不复位，1表示服务

**手动控制**

手动控制开关**（0x3100）：**

* X轴向左：0x3101
* X轴向右：0x3102
* Y轴向前：0x3103
* Y轴向后：0x3104
* Z轴上升：0x3105
* Z轴下降：0x3106

0xAABB +命令类型（**0x0011**）+命令字+长度（0x000C）+数据区（X轴数据区，Y轴数据区，Z轴数据区）+ crc16

数据区单位：μm

数据区：移动距离

#### 3.4.4 打印通讯  (0xF000段)

根据上位机配置**打印起点，和终点，X轴进行往复运动**

* Y轴移动步进（多PASS：融跃sdk获取下一pass位置信息）
* 打印层数（控制Z轴下降）

包头 + 命令类型+命令字+长度 +数据区（X轴数据区，Y轴步进数据，打印层数（控制Z轴下降））+ crc16

---

### 3.5 数据区

数据区字节：

**12字节：**

* 前4个字节为X轴数据区，中间4字节为Y轴数据区，后4字节为Z轴数据区。

**0字节：**

* 主要为不带数据的命令

---

### 3.6 CRC16检验（2字节）

固定字节版本：从包头到数据区的CRC16校验。

---

### 3.7 应答说明（0xAACC）

#### 3.7.1 设置参数：

**返回12字节**，数据区返回：0x0001（成功），0x0000（失败）

0xAACC+命令类型（**0x0001**)+命令字+ 长度(0x0001)+数据区（2字节）+ crc16

#### 3.7.2 获取命令：

**返回22字节**，其中12字节的数据区，前4个字节为X轴，最后4个字节为Z轴。

0xAACC+命令类型（**0x0010**)+命令字+ 长度(0x0001)+数据区（12字节）+ crc16

#### 3.7.3 控制命令：

**返回12字节**，数据区返回：0x0001（成功），0x0000（失败）

0xAACC+命令类型（**0x0011**)+命令字+ 长度(0x0001)+数据区（2字节）+ crc16

**3.****7****.4 固定上报信息：**

* 位置信息（40ms固定周期上报）
* X轴运动完成信息（也可从融跃板卡中获取当前pass打印完成信息）
